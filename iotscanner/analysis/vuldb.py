import requests
import time


class Vuldb:

    ENDPOINT = "https://vuldb.com/?api"

    def __init__(self, token):
        self.__token = token
        self.__request_timestamps = []

    def search(self, query):
        self.__wait_until_available()
        rq_body = {'search': query, 'apikey': self.__token}
        rs = requests.post(Vuldb.ENDPOINT, data=rq_body)
        self.__register_rq()
        if rs.status_code == 200:
            return rs.json()['result']
        else:
            return []

    def __register_rq(self):
        self.__request_timestamps.append(time.time())
        if len(self.__request_timestamps) > 10:
            self.__request_timestamps.pop()

    def __wait_until_available(self):
        if len(self.__request_timestamps) == 10:
            lapse = time.time() - self.__request_timestamps[0]
            if lapse < 60:
                time.sleep(60 - lapse)

